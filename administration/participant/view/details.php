<?php/* Add this on all pages on top. */set_include_path($_SERVER['DOCUMENT_ROOT'].'/'.PATH_SEPARATOR.$_SERVER['DOCUMENT_ROOT'].'/library/classes/');/*** Standard includes */require_once 'config/database.php';require_once 'config/smarty.php';/*** Check for login */require_once 'administration/includes/auth.php';/* objects. */require_once 'class/participant.php';require_once 'class/participantlogin.php';require_once 'class/File.php';$participantObject 			= new class_participant();$participantloginObject 	= new class_participantlogin();$fileObject 					= new File(array('gif', 'png', 'jpg', 'jpeg', 'gif'));if (isset($_GET['code']) && trim($_GET['code']) != '') {		$code = trim($_GET['code']);		$participantData = $participantObject->getByCode($code);		if($participantData) {		$smarty->assign('participantData', $participantData);	} else {		header('Location: /administration/participant/view/');		exit;			}}/* Check posted data. */if(count($_POST) > 0) {	$errorArray		= array();	$data 				= array();	$formValid		= true;	$success			= NULL;	$areaByName	= NULL;		if(isset($_POST['areapost_code']) && trim($_POST['areapost_code']) == '') {		$errorArray['areapost_code'] = 'required';		$formValid = false;			}		if(isset($_POST['participant_name']) && trim($_POST['participant_name']) == '') {		$errorArray['participant_name'] = 'required';		$formValid = false;			}		if(isset($_POST['participant_surname']) && trim($_POST['participant_surname']) == '') {		$errorArray['participant_surname'] = 'required';		$formValid = false;			}		if(isset($_POST['participant_gender']) && trim($_POST['participant_gender']) == '') {		$errorArray['participant_gender'] = 'required';		$formValid = false;			}	if((isset($_POST['participant_dateofbirth']) && trim($_POST['participant_dateofbirth']) != '') && (isset($_POST['participant_idnumber']) && trim($_POST['participant_idnumber']) != '')) {		if(date('ymd', strtotime(trim($_POST['participant_dateofbirth']))) != substr(trim($_POST['participant_idnumber']), 0, 6)) {			$errorArray['participant_idnumber'] = 'ID number should relate to the date of birth';			$formValid = false;		}	}		if(isset($_POST['participant_dateofbirth']) && trim($_POST['participant_dateofbirth']) != '') {		if(trim($_POST['participant_dateofbirth']) != date('Y-m-d', strtotime(trim($_POST['participant_dateofbirth'])))) {			$errorArray['participant_dateofbirth'] = 'required';			$formValid = false;				}	} else {		$errorArray['participant_dateofbirth'] = 'Date of birth is required';		$formValid = false;	}		if(isset($_POST['participant_idnumber']) && trim($_POST['participant_idnumber']) != '') {		if($participantObject->validateIDnumber(trim($_POST['participant_idnumber'])) == '') {			$errorArray['participant_idnumber'] = 'Needs to be a valid id number';			$formValid = false;			} else {						$idnumber = isset($participantData) ? $participantData['participant_code'] : null;						$idnumberData = $participantObject->getByIDnumber(trim($_POST['participant_idnumber']), $idnumber);						if($idnumberData) {				$errorArray['participant_idnumber'] = 'ID number already exists';				$formValid = false;							}		}	}		if(isset($_POST['participant_email']) && trim($_POST['participant_email']) != '') {		if($participantObject->validateEmail(trim($_POST['participant_email'])) == '') {			$errorArray['participant_email'] = 'Needs to be a valid email address';			$formValid = false;			} else {						$email = isset($participantData) ? $participantData['participant_code'] : null;						$emailData = $participantloginObject->checkEmail(trim($_POST['participant_email']), $email);						if($emailData) {				$errorArray['participant_email'] = 'Email already exists';				$formValid = false;							}		}	}		if(isset($_POST['participant_cellphone']) && trim($_POST['participant_cellphone']) != '') {		if($participantObject->validateCell(trim($_POST['participant_cellphone'])) == '') {			$errorArray['participant_cellphone'] = 'Needs to be a valid cellphone';			$formValid = false;			} else {						$cell = isset($participantData) ? $participantData['participant_code'] : null;						$cellData = $participantObject->getByCell(trim($_POST['participant_cellphone']), $cell);						if($cellData) {				$errorArray['participant_cellphone'] = 'Cell phone number already exists';				$formValid = false;							}		}	}		if(isset($_POST['participant_telephone']) && trim($_POST['participant_telephone']) != '') {		if($participantObject->validateCell(trim($_POST['participant_telephone'])) == '') {			$errorArray['participant_telephone'] = 'Needs to be a valid telephone number';			$formValid = false;			}	}		if(isset($_FILES['profile_image'])) {		/* Check validity of the CV. */		if((int)$_FILES['profile_image']['size'] != 0 && trim($_FILES['profile_image']['name']) != '') {			/* Check if its the right file. */			$ext = array_search($_FILES['profile_image']['type'], $fileObject->mime_types); 						if($ext != '') {				if(!$fileObject->valideExt($ext)) { 					$errorArray['profile_image'] = 'Invalid file type';					$formValid = false;										}			} else {				$errorArray['profile_image'] = 'Invalid file type';				$formValid = false;												}		}	}			if(count($errorArray) == 0 && $formValid == true) {				$data 	= array();						$data['areapost_code']					= trim($_POST['areapost_code']);				$data['participant_name']				= trim($_POST['participant_name']);				$data['participant_surname']			= trim($_POST['participant_surname']);				$data['participant_dateofbirth']		= trim($_POST['participant_dateofbirth']);				$data['participant_gender']				= trim($_POST['participant_gender']);				$data['participant_gender']				= trim($_POST['participant_gender']);			$data['participant_email']				= trim($_POST['participant_email']);				$data['participant_cellphone']			= trim($_POST['participant_cellphone']);				$data['participant_telephone']			= trim($_POST['participant_telephone']);					$data['participant_idnumber']			= trim($_POST['participant_idnumber']);							if(isset($participantData)) {						$data['participant_code'] = $participantData['participant_code'];						/*Update. */			$where		= $participantObject->getAdapter()->quoteInto('participant_code = ?', $participantData['participant_code']);			$success	= $participantObject->update($data, $where);				$success	= $data['participant_code'];					$datalogin = array();			$datalogin['participant_code'] 					= $success;			$datalogin['participantlogin_type'] 			= 'EMAIL';			$datalogin['participantlogin_username'] 	= $data['participant_email'];			$datalogin['participantlogin_name'] 			= $data['participant_name'];			$datalogin['participantlogin_lastlogin']		= date('Y-m-d h:i:s');						$where = array();			$where[]	= $participantloginObject->getAdapter()->quoteInto('participant_code = ?', $participantData['participant_code']);			$where[]	= $participantloginObject->getAdapter()->quoteInto('participantlogin_type = ?', 'EMAIL');			$success	= $participantloginObject->update($datalogin, $where);						} else {						$data['participant_active']		= 0;							$success = $participantObject->insert($data);						$datalogin = array();			$datalogin['participant_code'] 					= $success;			$datalogin['participantlogin_type'] 			= 'EMAIL';			$datalogin['participantlogin_username'] 		= $data['participant_email'];			$datalogin['participantlogin_name'] 			= $data['participant_name'];			$datalogin['participantlogin_active']			= 0;			$datalogin['participantlogin_location']			= trim($_POST['areapost_name']);						/* Insert the login data. */ 			$participantlogincode = $participantloginObject->insertLogin($datalogin, 'EMAIL', $success);				}				/* Upload image if its added. */		if((int)$_FILES['profile_image']['size'] != 0 && trim($_FILES['profile_image']['name']) != '') {						$image = array();			$image['participant_image_name']	= $participantObject->createFile();			$image['participant_image_path']		= '';			$image['participant_image_ext']		= '';						$ext 						= strtolower($fileObject->file_extention($_FILES['profile_image']['name']));								$filename				= $image['participant_image_name'].'.'.$ext;						$directory				= $_SERVER['DOCUMENT_ROOT'].'/media/participant/'.$success.'/';			$file						= $directory.'/'.$filename;							if(!is_dir($directory)) mkdir($directory, 0777, true);			/* Create files for this product type. */			foreach($fileObject->image as $item) {								$newfilename = str_replace($filename, $item['code'].$filename, $file);								/* Create new file and rename it. */				$uploadObject	= PhpThumbFactory::create($_FILES['profile_image']['tmp_name']);				$uploadObject->resize($item['width'], $item['height']);				$uploadObject->save($newfilename);						}			$image['participant_image_path']	= '/media/participant/'.$success.'/';			$image['participant_image_ext']		= '.'.$ext;			$image['participant_code'] 				= $success;						$where = $participantObject->getAdapter()->quoteInto('participant_code = ?', $success);			$participantObject->update($image, $where);							}				if(count($errorArray) == 0) {			header('Location: /administration/participant/view/');				exit;				}					}		/* if we are here there are errors. */	$smarty->assign('errorArray', $errorArray);	}$smarty->display('administration/participant/view/details.tpl');?>