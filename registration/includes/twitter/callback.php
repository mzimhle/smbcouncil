<?php /* Add this on all pages on top. */set_include_path($_SERVER['DOCUMENT_ROOT'].'/'.PATH_SEPARATOR.$_SERVER['DOCUMENT_ROOT'].'/library/classes/');/* include the Zend class for Authentification *//* Start session and load library. */require_once('Zend/Session.php');require_once 'config/database.php';require_once('twitter/twitteroauth.php');require_once('global_functions.php');$zfsession = new Zend_Session_Namespace('FrontSubscriber');if(!empty($_GET['oauth_verifier']) && !empty($zfsession->oauth_token) && !empty($zfsession->oauth_token_secret)){	/* TwitterOAuth instance, with two new parameters we got in twitter_login.php */	$twitteroauth = new TwitterOAuth(CONSUMER_KEY, CONSUMER_SECRET, $zfsession->oauth_token, $zfsession->oauth_token_secret);	/* Let's request the access token */	$access_token = $twitteroauth->getAccessToken($_GET['oauth_verifier']);	/* Save it in a session var */	$zfsession->access_token = $access_token;	/* Let's get the user's info */	$user_info = $twitteroauth->get('account/verify_credentials');	/* Save the data if its not present. */ 	if(!isset($user_info->error)) {		/* Get classese and objects. */		require_once 'class/participant.php';		/* Get Object. */		$participantObject 			= new class_participant();		/* Check if user already exists. check by ID. */		$twitterData = $participantObject->checkTwitter(trim($user_info->id));		/* insert if not present. */		if(!$twitterData) {			/* Build data. */			$data 	= array();				$data['participant_code']								= $participantObject->createReference();			$data['participant_name'] 								= isset($user_info->name) && trim($user_info->name) != '' ? trim($user_info->name) : null;			$data['participant_username'] 						= $data['participant_code'];			$data['participant_registration_confirmation'] 	= md5($data['participant_code']);			$data['participant_active']	 							= 1;			$data['participant_logintype'] 							= 'twitter';			$data['participant_password'] 							= $participantObject->createPassword();			$data['participant_twitter_uid']						= isset($user_info->id) && trim($user_info->id) != '' ? trim($user_info->id) : null;			$data['participant_twitter_name']					= isset($user_info->name) && trim($user_info->name) != '' ? trim($user_info->name) : null;			$data['participant_twitter_username']				= isset($user_info->screen_name) && trim($user_info->screen_name) != '' ? trim($user_info->screen_name) : null;			$data['participant_twitter_image']					= isset($user_info->profile_image_url) && trim($user_info->profile_image_url) != '' ? trim($user_info->profile_image_url) : null;			$data['participant_twitter_following']				= isset($user_info->following) && ($user_info->following == true || $user_info->following == 1) ? 1 : 0;			/* Insert the data. */ 			$participantObject->insert($data);		}		/* Setup the login variables. */		$zfsession->identity			= trim($user_info->id);		$zfsession->twitter_uid		= isset($user_info->id) && trim($user_info->id) != '' ? trim($user_info->id) : null;			/* Update "last login" */		$data = array('participant_last_login' => date('Y-m-d H:i:s'));		$where = $participantObject->getAdapter()->quoteInto('participant_twitter_uid = ?', trim($user_info->id));		$participantObject->update($data, $where);			/* Clean up. */		$participantObject = $data = $where = $user_info = $access_token = $twitteroauth = NULL;		UNSET($participantObject, $data, $where, $user_info, $access_token, $twitteroauth);			} else {			header('Location: /test/twitter/error-page/');		exit;				}} else {	/* Clean up. */	$zfsession = NULL; UNSET($zfsession);}header('Location: /test/twitter/');exit;